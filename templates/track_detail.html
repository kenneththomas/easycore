<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>{{ track.nickname or track.original_filepath }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    <style>
      .hero {
        position: relative; height: 260px;
        background: #111 center/cover no-repeat;
        color: #fff; display:flex; align-items:flex-end;
      }
      .hero::after { content:''; position:absolute; inset:0; background: linear-gradient(180deg,rgba(0,0,0,0.0),rgba(0,0,0,0.6)); }
      .hero-content { position: relative; padding: 16px; z-index: 1; }
      .title { font-size: 24px; font-weight: 700; margin: 0 0 4px; }
      .meta { color: #ddd; font-size: 12px; }
      .container { max-width: 960px; margin: 0 auto; padding: 16px; }
      .player { background: #fff; border:1px solid #eee; border-radius: 8px; padding: 12px; margin-top: -40px; position: relative; z-index: 2; }
      .controls { display:flex; align-items:center; gap:10px; margin-bottom: 8px; }
      .comments { margin-top: 16px; }
      .comment { border-top: 1px solid #eee; padding: 10px 0; }
      .related { margin-top: 24px; }
      .button { padding: 6px 10px; border:1px solid #ccc; border-radius: 6px; background:#fafafa; cursor:pointer; }
      #waveform { height: 120px; }
    </style>
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
  </head>
  <body>
    {% from 'navbar.html' import render_navbar %}
    {{ render_navbar() }}

    <div class="hero" {% if track.background_image_path %}style="background-image:url('{{ url_for('static', filename=track.background_image_path) }}')"{% endif %}>
      <div class="hero-content">
        <h1 class="title">{{ track.nickname or track.original_filepath }}</h1>
        <div class="meta">
          {% if artists and artists|length %}
            by
            {% for a in artists %}
              <a href="{{ url_for('artist_detail', artist_id=a.id) }}" style="color:#fff; text-decoration: underline;">{{ a.name }}</a>{% if not loop.last %}, {% endif %}
            {% endfor %}
            Â·
          {% endif %}
          {{ track.tags }} Â· {{ track.view_count or 0 }} plays Â· {{ track.likes or 0 }} likes
        </div>
      </div>
    </div>

    <div class="container">
      <div class="player">
        <div class="controls">
          <button id="playPause" class="button">Play</button>
          <button id="likeBtn" class="button">Like ({{ track.likes or 0 }})</button>
        </div>
        <div id="waveform"></div>
      </div>

      <div class="comments">
        <h3>Comments</h3>
        <form id="commentForm" autocomplete="off">
          <div style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
            <input type="text" name="author" placeholder="Your name" required autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" readonly style="flex: 1;" />
            <div class="ai-comment-dropdown" style="position: relative;">
              <button type="button" id="aiCommentBtn" class="button" style="background: #667eea; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                ðŸ¤– AI Comment
              </button>
              <div id="aiCommentDropdown" class="ai-dropdown-content" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; min-width: 300px; padding: 12px;">
                <div style="margin-bottom: 8px;">
                  <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #333;">Comment Style:</label>
                  <select id="aiPromptSelect" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    <option value="general">General fan comment</option>
                    <option value="positive">Enthusiastic comment</option>
                    <option value="critical">Thoughtful critique</option>
                    <option value="discovery">Just discovered this</option>
                    <option value="nostalgic">Nostalgic comment</option>
                    <option value="technical">Technical analysis</option>
                    <option value="emotional">Emotional response</option>
                    <option value="comparison">Compare to other music</option>
                    <option value="custom">Custom prompt...</option>
                  </select>
                </div>
                <div id="customPromptDiv" style="display: none; margin-bottom: 8px;">
                  <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #333;">Custom Prompt:</label>
                  <textarea id="customPrompt" placeholder="Enter your custom prompt..." style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; resize: vertical; min-height: 60px;"></textarea>
                </div>
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                  <button type="button" id="generateAiComment" class="button" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                    Generate
                  </button>
                  <button type="button" id="closeAiDropdown" class="button" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>
          <input type="text" name="content" placeholder="Write a comment" required autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" readonly />
          <button class="button" type="submit">Post</button>
        </form>
        <div id="commentList">
          {% for c in comments %}
            <div class="comment" data-id="{{ c.id }}">
              <div style="display:flex; align-items:center; gap:8px;">
                {% set av = author_avatars.get(c.author|slugify) %}
                <img alt="avatar" src="{% if av %}{{ url_for('static', filename=av) }}{% else %}{{ url_for('static', filename='avatars/default.png') }}{% endif %}" style="width:24px; height:24px; border-radius:50%; object-fit:cover;" />
                <strong><a href="{{ url_for('artist_by_name', artist_name=c.author) }}">{{ c.author }}</a></strong>
                <span style="color:#777; font-size:12px;">{{ c.timestamp.strftime('%m/%d/%Y %I:%M %p') }}</span>
              </div>
              <div>{{ c.content }}</div>
              <button class="button like-comment">Like ({{ c.likes or 0 }})</button>
              <button class="button delete-comment">Delete</button>
            </div>
          {% endfor %}
        </div>
      </div>

      {% if related_tracks %}
      <div class="related">
        <h3>Related Tracks</h3>
        <ul>
          {% for t in related_tracks %}
            <li><a href="{{ url_for('track_detail', track_id=t.id) }}">{{ t.nickname or t.original_filepath }}</a></li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>

    <script>
      const wavesurfer = WaveSurfer.create({
        container: '#waveform',
        waveColor: '#aaa',
        progressColor: '#ff5500',
        height: 120,
        barWidth: 2,
        barGap: 1,
        cursorColor: '#333',
      })

      wavesurfer.load("{{ url_for('stream_track', track_id=track.id) }}")

      const btn = document.getElementById('playPause')
      btn.addEventListener('click', () => {
        wavesurfer.playPause()
        btn.textContent = wavesurfer.isPlaying() ? 'Pause' : 'Play'
      })

      document.getElementById('likeBtn').addEventListener('click', async (e) => {
        const res = await fetch("{{ url_for('like_track', track_id=track.id) }}", { method: 'POST' })
        const json = await res.json()
        if (json.success) e.target.textContent = `Like (${json.new_like_count})`
      })

      // Disable browser autofill by making fields readonly until user interacts
      document.querySelectorAll('#commentForm input[type="text"]').forEach((el) => {
        const unlock = () => el.removeAttribute('readonly')
        el.addEventListener('focus', unlock, { once: true })
        el.addEventListener('mousedown', unlock, { once: true })
        el.addEventListener('touchstart', unlock, { once: true })
      })

      // Comments
      const form = document.getElementById('commentForm')
      form.addEventListener('submit', async (e) => {
        e.preventDefault()
        const data = new FormData(form)
        const res = await fetch("{{ url_for('add_track_comment', track_id=track.id) }}", { method: 'POST', body: data })
        const json = await res.json()
        if (json.success) {
          const c = json.comment
          const div = document.createElement('div')
          div.className = 'comment'
          div.dataset.id = c.id
          div.innerHTML = `<div><strong><a href="/artist/${c.author}">${c.author}</a></strong> <span style="color:#777; font-size:12px;">${c.timestamp}</span></div>
                           <div>${c.content}</div>
                           <button class="button like-comment">Like (${c.likes})</button>
                           <button class="button delete-comment">Delete</button>`
          document.getElementById('commentList').prepend(div)
          form.reset()
        }
      })

      document.getElementById('commentList').addEventListener('click', async (e) => {
        const item = e.target.closest('.comment')
        if (!item) return
        const id = item.dataset.id
        if (e.target.classList.contains('like-comment')) {
          const res = await fetch(`{{ url_for('like_track_comment', comment_id=0) }}`.replace('0', id), { method: 'POST' })
          const json = await res.json()
          if (json.success) e.target.textContent = `Like (${json.new_like_count})`
        }
        if (e.target.classList.contains('delete-comment')) {
          const res = await fetch(`{{ url_for('delete_track_comment', comment_id=0) }}`.replace('0', id), { method: 'POST' })
          const json = await res.json()
          if (json.success) item.remove()
        }
      })

      // AI Comment Generation
      const aiCommentBtn = document.getElementById('aiCommentBtn')
      const aiCommentDropdown = document.getElementById('aiCommentDropdown')
      const aiPromptSelect = document.getElementById('aiPromptSelect')
      const customPromptDiv = document.getElementById('customPromptDiv')
      const customPrompt = document.getElementById('customPrompt')
      const generateAiComment = document.getElementById('generateAiComment')
      const closeAiDropdown = document.getElementById('closeAiDropdown')
      const contentInput = document.querySelector('input[name="content"]')

      // Toggle AI dropdown
      aiCommentBtn.addEventListener('click', (e) => {
        e.stopPropagation()
        aiCommentDropdown.style.display = aiCommentDropdown.style.display === 'none' ? 'block' : 'none'
      })

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!aiCommentDropdown.contains(e.target) && !aiCommentBtn.contains(e.target)) {
          aiCommentDropdown.style.display = 'none'
        }
      })

      // Show/hide custom prompt field
      aiPromptSelect.addEventListener('change', () => {
        if (aiPromptSelect.value === 'custom') {
          customPromptDiv.style.display = 'block'
          customPrompt.focus()
        } else {
          customPromptDiv.style.display = 'none'
          customPrompt.value = ''
        }
      })

      // Close dropdown
      closeAiDropdown.addEventListener('click', () => {
        aiCommentDropdown.style.display = 'none'
      })

      // Generate AI comment
      generateAiComment.addEventListener('click', async () => {
        const selectedStyle = aiPromptSelect.value
        let prompt = ''
        
        if (selectedStyle === 'custom') {
          prompt = customPrompt.value.trim()
          if (!prompt) {
            alert('Please enter a custom prompt')
            return
          }
        } else {
          // Use predefined prompts
          const prompts = {
            general: `What would a music fan think about {{ track.nickname or track.original_filepath }} by {{ artists[0].name if artists else 'Unknown Artist' }}?`,
            positive: `Write an enthusiastic comment about {{ track.nickname or track.original_filepath }} by {{ artists[0].name if artists else 'Unknown Artist' }}`,
            critical: `Write a thoughtful, slightly critical comment about {{ track.nickname or track.original_filepath }} by {{ artists[0].name if artists else 'Unknown Artist' }}`,
            discovery: `Write a comment from someone who just discovered {{ track.nickname or track.original_filepath }} by {{ artists[0].name if artists else 'Unknown Artist' }}`,
            nostalgic: `Write a nostalgic comment about {{ track.nickname or track.original_filepath }} by {{ artists[0].name if artists else 'Unknown Artist' }}`,
            technical: `Write a comment focusing on the technical aspects of {{ track.nickname or track.original_filepath }} by {{ artists[0].name if artists else 'Unknown Artist' }}`,
            emotional: `Write an emotional comment about {{ track.nickname or track.original_filepath }} by {{ artists[0].name if artists else 'Unknown Artist' }}`,
            comparison: `Write a comment comparing {{ track.nickname or track.original_filepath }} by {{ artists[0].name if artists else 'Unknown Artist' }} to other music`
          }
          prompt = prompts[selectedStyle]
        }

        // Show loading state
        generateAiComment.textContent = 'Generating...'
        generateAiComment.disabled = true

        try {
          const response = await fetch(`{{ url_for('generate_track_comment', track_id=track.id) }}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ prompt: prompt })
          })

          const result = await response.json()
          console.log('AI Comment Response:', result)

          if (result.success) {
            console.log('Setting comment content:', result.comment)
            contentInput.value = result.comment
            contentInput.removeAttribute('readonly')
            aiCommentDropdown.style.display = 'none'
          } else {
            console.error('AI Comment Error:', result.error)
            alert('Error generating comment: ' + (result.error || 'Unknown error'))
          }
        } catch (error) {
          alert('Error generating comment: ' + error.message)
        } finally {
          generateAiComment.textContent = 'Generate'
          generateAiComment.disabled = false
        }
      })
    </script>
  </body>
 </html>

