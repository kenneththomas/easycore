<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Add Track</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    <style>
      .form-group { margin: 12px 0; }
      .container { max-width: 700px; margin: 20px auto; }
      .help { color: #777; font-size: 12px; }
      .drag-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 123, 255, 0.1);
        border: 3px dashed #007bff;
        display: none;
        z-index: 1000;
        pointer-events: none;
      }
      .drag-overlay.active {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: #007bff;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="drag-overlay" id="dragOverlay">Drop audio file here</div>
    <div class="container">
      <h2>Upload Audio Track</h2>
      <form id="trackForm" enctype="multipart/form-data" method="post">
        <div class="form-group">
          <label>Audio file (.mp3, .wav, .ogg, .flac, .m4a)</label>
          <input type="file" name="file" accept="audio/*" required />
        </div>
        <div class="form-group">
          <label>Background image (optional)</label>
          <input type="file" name="background" accept="image/*" />
          <div class="help">Shown behind the waveform, similar to SoundCloud covers.</div>
        </div>
        <div class="form-group">
          <label>Title</label>
          <input type="text" name="nickname" placeholder="Track title" />
        </div>
        <div class="form-group">
          <label>Artist (optional)</label>
          <input type="text" name="artist_name" placeholder="Artist name" />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea name="description" rows="3" placeholder="Describe your track"></textarea>
        </div>
        <div class="form-group">
          <label>Tags (comma-separated)</label>
          <input type="text" name="tags" placeholder="chill, lofi" />
        </div>
        <div class="form-group">
          <label><input type="checkbox" name="stealth" /> Upload to stealth audio</label>
        </div>
        <button type="submit">Upload</button>
      </form>
      <div id="result" style="margin-top:16px;"></div>
    </div>

    <script>
    const form = document.getElementById('trackForm');
    const fileInput = document.querySelector('input[name="file"]');
    const dragOverlay = document.getElementById('dragOverlay');
    
    // Form submission handler
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = new FormData(form);
      const res = await fetch('{{ url_for('add_track') }}', { method: 'POST', body: data });
      const json = await res.json();
      const result = document.getElementById('result');
      if (json.success) {
        result.innerHTML = `Uploaded! <a href="${'${'}{{ url_for('track_detail', track_id=0) }}${'}'}" onclick="event.preventDefault(); window.location='${'${'}'${'}'}'">`;
        window.location = `{{ url_for('track_detail', track_id=0) }}`.replace('0', json.track_id);
      } else {
        result.textContent = json.error || 'Upload failed';
      }
    });

    // Drag and drop functionality
    function isValidAudioFile(file) {
      const audioTypes = ['audio/mpeg', 'audio/wav', 'audio/ogg', 'audio/flac', 'audio/mp4', 'audio/x-m4a'];
      const validExtensions = ['.mp3', '.wav', '.ogg', '.flac', '.m4a'];
      
      return audioTypes.includes(file.type) || 
             validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
    }

    function handleFiles(files) {
      if (files.length > 0) {
        const file = files[0];
        if (isValidAudioFile(file)) {
          // Create a new FileList with the dropped file
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          fileInput.files = dataTransfer.files;
          
          // Trigger change event to update any file display
          fileInput.dispatchEvent(new Event('change', { bubbles: true }));
        } else {
          alert('Please drop a valid audio file (.mp3, .wav, .ogg, .flac, .m4a)');
        }
      }
    }

    // Prevent default drag behaviors on the entire document
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      document.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });

    // Show drag overlay when dragging over the window
    ['dragenter', 'dragover'].forEach(eventName => {
      document.addEventListener(eventName, (e) => {
        dragOverlay.classList.add('active');
      });
    });

    // Hide drag overlay when leaving the window
    ['dragleave', 'drop'].forEach(eventName => {
      document.addEventListener(eventName, (e) => {
        dragOverlay.classList.remove('active');
      });
    });

    // Handle file drop
    document.addEventListener('drop', (e) => {
      const files = e.dataTransfer.files;
      handleFiles(files);
    });
    </script>
  </body>
 </html>

